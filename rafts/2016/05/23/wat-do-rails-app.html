<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Wat Do?! A Simple Rails App</title>
  <meta name="description" content="Intro:">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="/2016/05/23/wat-do-rails-app.html">
  <link rel="alternate" type="application/rss+xml" title="Rubynilia" href="/feed.xml">
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">Rubynilia</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
          <a class="page-link" href="/about/">About</a>
          
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Wat Do?! A Simple Rails App</h1>
    <p class="post-meta"><time datetime="2016-05-23T00:00:00-07:00" itemprop="datePublished">May 23, 2016</time></p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <h2 id="intro">Intro:</h2>

<p>This post is a journal for the process of creating a website in Rails. Some degree of familiarity with Ruby and Rails by the reader is assumed. Our objective is to create a website that utilizes authentication and authorization (and also allow authentication from an outside service). It will also utilize nested resources and routes. For this project, we’re going to build a site that can manage events. We want our users to be able to create events that other users can sign up to attend, and tag their own events with tag categories. Some code will be intentionally left out but my full code can be found on my repo, linked at the bottom of this post. Let’s get started!</p>

<h2 id="getting-started">Getting Started:</h2>

<p>First, we create our models and migrations. I use regular old rails generators to create the files with</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">  rails generate model Event</code></pre></figure>

<p>and fill in the changes needed afterwards.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby">  <span class="k">class</span> <span class="nc">CreateEvents</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
    <span class="k">def</span> <span class="nf">change</span>
      <span class="n">create_table</span> <span class="ss">:events</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
        <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span>
        <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:location</span>
        <span class="n">t</span><span class="p">.</span><span class="nf">text</span> <span class="ss">:description</span>
        <span class="n">t</span><span class="p">.</span><span class="nf">datetime</span> <span class="ss">:start_time</span>
        <span class="n">t</span><span class="p">.</span><span class="nf">datetime</span> <span class="ss">:end_time</span>
        <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:time_zone</span>
        <span class="n">t</span><span class="p">.</span><span class="nf">references</span> <span class="ss">:user</span><span class="p">,</span> <span class="ss">index: </span><span class="kp">true</span>

        <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span> <span class="ss">null: </span><span class="kp">false</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span></code></pre></figure>

<p>Continue to generate and write out migrations for the <code class="highlighter-rouge">User</code>, <code class="highlighter-rouge">Tag</code> and <code class="highlighter-rouge">Comment</code> models. Our comment model will also serve as a join table that can have an attribute <code class="highlighter-rouge">:content</code> to hold the text for a comment in addition to tying a user_id to an event. We’ll also want a second join table for <code class="highlighter-rouge">Event</code>s and <code class="highlighter-rouge">Tag</code>s and a model for <code class="highlighter-rouge">EventTag</code>, since <code class="highlighter-rouge">Event</code>s can have many <code class="highlighter-rouge">Tag</code>s, and <code class="highlighter-rouge">Tag</code>s can have many <code class="highlighter-rouge">Event</code>s.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby">  <span class="k">class</span> <span class="nc">CreateComments</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
    <span class="k">def</span> <span class="nf">change</span>
      <span class="n">create_table</span> <span class="ss">:comments</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
        <span class="n">t</span><span class="p">.</span><span class="nf">text</span> <span class="ss">:content</span>
        <span class="n">t</span><span class="p">.</span><span class="nf">references</span> <span class="ss">:user</span><span class="p">,</span> <span class="ss">index: </span><span class="kp">true</span>
        <span class="n">t</span><span class="p">.</span><span class="nf">references</span> <span class="ss">:event</span><span class="p">,</span> <span class="ss">index: </span><span class="kp">true</span>

        <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span> <span class="ss">null: </span><span class="kp">false</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="c1"># add another migration file</span>
  <span class="k">class</span> <span class="nc">CreateJoinTableEventTags</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
    <span class="k">def</span> <span class="nf">change</span>
      <span class="n">create_table</span> <span class="ss">:event_tags</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
        <span class="n">t</span><span class="p">.</span><span class="nf">integer</span> <span class="ss">:event_id</span>
        <span class="n">t</span><span class="p">.</span><span class="nf">integer</span> <span class="ss">:tag_id</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span></code></pre></figure>

<p>And also another join table for the users and events tables so we can build out the feature to allow users to ‘attend’ events. We’ll call this join table <code class="highlighter-rouge">Schedule</code>s.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby">  <span class="k">class</span> <span class="nc">CreateSchedules</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
    <span class="k">def</span> <span class="nf">change</span>
      <span class="n">create_table</span> <span class="ss">:schedules</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
        <span class="n">t</span><span class="p">.</span><span class="nf">integer</span> <span class="ss">:event_id</span>  <span class="c1"># works the same as t.references :event, index: true</span>
        <span class="n">t</span><span class="p">.</span><span class="nf">integer</span> <span class="ss">:user_id</span>

        <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span> <span class="ss">null: </span><span class="kp">false</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span></code></pre></figure>

<p>Now to add Devise to handle our authentication needs. Include the devise gem in our Gemfile. We’ll also include Pundit and Omniauth while we’re at it to handle roles and outside authentication service. I’ve decided to use GitHub for this site.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby">  <span class="n">gem</span> <span class="s1">'devise'</span>
  <span class="n">gem</span> <span class="s1">'pundit'</span>
  <span class="n">gem</span> <span class="s1">'omniauth'</span>
  <span class="n">gem</span> <span class="s1">'omniauth-github'</span>
  <span class="n">gem</span> <span class="s1">'dot-env'</span></code></pre></figure>

<p>Run bundle to install the gems</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">  bundle install</code></pre></figure>

<p>GitHub omniauth requires that we get <code class="highlighter-rouge">GITHUB_KEY</code> and <code class="highlighter-rouge">GITHUB_SECRET</code> keys from github for authentication.  You can obtain these directly from github by logging in or creating an account and creating a new application. Get the keys from GitHub and create a new a file the site’s root directory called .env (note: this is a file with no name that has an extension of .env). The dot-env gem included above will allow rails to grab the values from the .env file.</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">  touch .env</code></pre></figure>

<p>Now add the keys to the .env file, replacing <code class="highlighter-rouge">&lt;YOUR_KEY&gt;</code> AND <code class="highlighter-rouge">&lt;YOUR_SECRET&gt;</code> with your values from GitHub (or whatever provider you chose)</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby">  <span class="no">GITHUB_KEY</span><span class="o">=&lt;</span><span class="no">YOUR_KEY</span><span class="o">&gt;</span>
  <span class="no">GITHUB_SECRET</span><span class="o">=&lt;</span><span class="no">YOUR_SECRET</span><span class="o">&gt;</span></code></pre></figure>

<p>Then add Devise to Users so that it can do it’s magic</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">  rails generate devise:install Users</code></pre></figure>

<p>Then to add Omniauth capability to our Users</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">  rails generate migration AddOmniauthToUsers provider:string uid:string</code></pre></figure>

<p>Add roles to our User model. Normal users will be create by default. Admins can modify everything but will not be able to be created from sign up.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby">  <span class="k">class</span> <span class="nc">AddRolesToUsers</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
    <span class="k">def</span> <span class="nf">change</span>
      <span class="n">add_column</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:role</span><span class="p">,</span> <span class="ss">:integer</span><span class="p">,</span> <span class="ss">default: </span><span class="mi">0</span>
    <span class="k">end</span>
  <span class="k">end</span></code></pre></figure>

<p>We’ll also need to make changes to our config/devise.rb file to include a config line that will allow Omniauth to work with Devise. We add this line to the devise.rb file instead of omniauth config since we are using Devise for authentication.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby">  <span class="c1"># add this line inside the Devise.setup block to allow omniauth with github</span>
  <span class="c1"># scope: 'user' will allow our site to use the info in the user hash sent back from github</span>
  <span class="no">Devise</span><span class="p">.</span><span class="nf">setup</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
    <span class="n">config</span><span class="p">.</span><span class="nf">omniauth</span> <span class="ss">:github</span><span class="p">,</span> <span class="no">ENV</span><span class="p">[</span><span class="s1">'GITHUB_KEY'</span><span class="p">],</span> <span class="no">ENV</span><span class="p">[</span><span class="s1">'GITHUB_SECRET'</span><span class="p">],</span> <span class="ss">scope: </span><span class="s1">'user'</span>
  <span class="k">end</span></code></pre></figure>

<p>Then we want to include our migrations to create our tables</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">  rake db:migrate
  <span class="c"># seed our database with fake data if you have some seed data</span>
  rake db:seed</code></pre></figure>

<p>Now to make sure that our routes are setup properly. Remember we want to make use of nested routes for our comments, since a comment belongs to a user. In addition to setting up a Static controller to handle our home page, we’ll also want to create a new controller to handle omniauth callbacks for omniauth sign ins. This controller will handle all the data that is sent back from github (callbacks)</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby">  <span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
    <span class="n">resources</span> <span class="ss">:tags</span>
    <span class="n">devise_for</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:controllers</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:omniauth_callbacks</span> <span class="o">=&gt;</span> <span class="s2">"users/omniauth_callbacks"</span> <span class="p">}</span>

    <span class="n">resources</span> <span class="ss">:users</span> <span class="k">do</span>
      <span class="n">resources</span> <span class="ss">:comments</span>
    <span class="k">end</span>
    <span class="n">resources</span> <span class="ss">:schedules</span>
    <span class="n">resources</span> <span class="ss">:events</span>

    <span class="n">root</span> <span class="s1">'static#home'</span>
  <span class="k">end</span></code></pre></figure>

<p>Create the omniauth callbacks controller. I’ve decided to create a app/controllers/users folder and stick a newly created omniauth_callbacks_controller.rb which inherits from the Devise’s omniauth controller.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby">  <span class="c1"># app/controllers/users/omniauth_callbacks_controller.rb</span>
  <span class="k">class</span> <span class="nc">Users</span><span class="o">::</span><span class="no">OmniauthCallbacksController</span> <span class="o">&lt;</span> <span class="no">Devise</span><span class="o">::</span><span class="no">OmniauthCallbacksController</span>

    <span class="k">def</span> <span class="nf">github</span>
      <span class="c1"># You need to implement the method below in your model (e.g. app/models/user.rb)</span>
      <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">from_omniauth</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="nf">env</span><span class="p">[</span><span class="s2">"omniauth.auth"</span><span class="p">])</span>
      <span class="k">if</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">persisted?</span>
        <span class="n">sign_in_and_redirect</span> <span class="vi">@user</span>
        <span class="n">set_flash_message</span><span class="p">(</span><span class="ss">:notice</span><span class="p">,</span> <span class="ss">:success</span><span class="p">,</span> <span class="ss">:kind</span> <span class="o">=&gt;</span> <span class="s2">"Github"</span><span class="p">)</span> <span class="k">if</span> <span class="n">is_navigational_format?</span>
      <span class="k">else</span>
        <span class="n">session</span><span class="p">[</span><span class="s2">"devise.github_data"</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="nf">env</span><span class="p">[</span><span class="s2">"omniauth.auth"</span><span class="p">]</span>
        <span class="n">redirect_to</span> <span class="n">new_user_session_path</span><span class="p">,</span> <span class="ss">flash: </span><span class="p">{</span><span class="ss">error: </span><span class="s1">'There was an error.'</span><span class="p">}</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="c1"># handle uh oh behavior so your site doesn't freak out when authentication fails</span>
    <span class="k">def</span> <span class="nf">failure</span>
      <span class="n">redirect_to</span> <span class="n">root_path</span>
    <span class="k">end</span>

<span class="k">end</span></code></pre></figure>

<p>Modify the User.rb model file to look for or create users from GitHub. You might want also want to add a couple of simple validations along with defining pundit roles with enum and devise options to allow omniauth. The below also has some ActiveRecord association macros needed for interacting with other models.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby">  <span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>

    <span class="n">devise</span> <span class="ss">:database_authenticatable</span><span class="p">,</span> <span class="ss">:registerable</span><span class="p">,</span>
           <span class="ss">:recoverable</span><span class="p">,</span> <span class="ss">:rememberable</span><span class="p">,</span> <span class="ss">:trackable</span><span class="p">,</span> <span class="ss">:validatable</span><span class="p">,</span> <span class="ss">:omniauthable</span><span class="p">,</span> <span class="ss">:omniauth_providers</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="ss">:github</span><span class="p">]</span>

    <span class="n">has_many</span> <span class="ss">:schedules</span>
    <span class="n">has_many</span> <span class="ss">:events</span><span class="p">,</span> <span class="ss">through: :schedules</span><span class="c1">#, source: :event</span>
    <span class="n">has_many</span> <span class="ss">:locations</span><span class="p">,</span> <span class="ss">through: :events</span>

    <span class="n">has_many</span> <span class="ss">:comments</span>

    <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span>
    <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">uniqueness: </span><span class="kp">true</span>


    <span class="n">enum</span> <span class="ss">role: </span><span class="p">[</span><span class="ss">:normal</span><span class="p">,</span> <span class="ss">:moderator</span><span class="p">,</span> <span class="ss">:admin</span><span class="p">]</span>

    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">from_omniauth</span><span class="p">(</span><span class="n">auth</span><span class="p">)</span>
      <span class="n">where</span><span class="p">(</span><span class="ss">provider: </span><span class="n">auth</span><span class="p">.</span><span class="nf">provider</span><span class="p">,</span> <span class="ss">uid: </span><span class="n">auth</span><span class="p">.</span><span class="nf">uid</span><span class="p">).</span><span class="nf">first_or_create</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span>
        <span class="n">user</span><span class="p">.</span><span class="nf">email</span> <span class="o">=</span> <span class="n">auth</span><span class="p">.</span><span class="nf">info</span><span class="p">.</span><span class="nf">email</span>
        <span class="n">user</span><span class="p">.</span><span class="nf">password</span> <span class="o">=</span> <span class="no">Devise</span><span class="p">.</span><span class="nf">friendly_token</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">20</span><span class="p">]</span>
        <span class="n">user</span><span class="p">.</span><span class="nf">name</span> <span class="o">=</span> <span class="n">auth</span><span class="p">.</span><span class="nf">info</span><span class="p">.</span><span class="nf">name</span> <span class="o">||</span> <span class="n">user</span><span class="p">.</span><span class="nf">auth</span><span class="p">.</span><span class="nf">info</span><span class="p">.</span><span class="nf">username</span>
      <span class="k">end</span>
    <span class="k">end</span>

  <span class="k">end</span></code></pre></figure>

<h2 id="building-mvc">Building MVC:</h2>

<p>Now to build out the rest of the models, views, and controllers. We start by building out the rest of models with the proper association macros</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby">  <span class="k">class</span> <span class="nc">Schedule</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
    <span class="n">belongs_to</span> <span class="ss">:user</span>
    <span class="n">belongs_to</span> <span class="ss">:event</span>
  <span class="k">end</span>

  <span class="k">class</span> <span class="nc">Tag</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
    <span class="n">has_many</span> <span class="ss">:event_tags</span>
    <span class="n">has_many</span> <span class="ss">:events</span><span class="p">,</span> <span class="ss">through: :event_tags</span>
  <span class="k">end</span>

  <span class="k">class</span> <span class="nc">EventTag</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
    <span class="n">belongs_to</span> <span class="ss">:event</span>
    <span class="n">belongs_to</span> <span class="ss">:tag</span>
  <span class="k">end</span>

  <span class="k">class</span> <span class="nc">Comment</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
    <span class="n">belongs_to</span> <span class="ss">:user</span>
    <span class="n">belongs_to</span> <span class="ss">:event</span>
  <span class="k">end</span></code></pre></figure>

<p>The event class will have a bit more code to help validate attributes and also make the time objects for the event more readable in our views</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby">  <span class="k">class</span> <span class="nc">Event</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
    <span class="n">belongs_to</span> <span class="ss">:organizer</span><span class="p">,</span> <span class="ss">:foreign_key</span> <span class="o">=&gt;</span> <span class="s2">"user_id"</span><span class="p">,</span> <span class="ss">:class_name</span> <span class="o">=&gt;</span> <span class="s1">'User'</span>
    <span class="n">has_many</span> <span class="ss">:schedules</span>
    <span class="n">has_many</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">through: :schedules</span><span class="c1">#, source: :user</span>
    <span class="n">has_many</span> <span class="ss">:comments</span>
    <span class="n">has_many</span> <span class="ss">:event_tags</span>
    <span class="n">has_many</span> <span class="ss">:tags</span><span class="p">,</span> <span class="ss">through: :event_tags</span>
    <span class="n">accepts_nested_attributes_for</span> <span class="ss">:tags</span>

    <span class="n">validates_presence_of</span> <span class="ss">:description</span><span class="p">,</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:location</span><span class="p">,</span> <span class="ss">:start_time</span><span class="p">,</span> <span class="ss">:end_time</span>
    <span class="n">validate</span> <span class="ss">:event_cannot_start_in_the_past</span><span class="p">,</span> <span class="ss">:event_cannot_end_before_start_time</span>

    <span class="k">def</span> <span class="nf">start_time</span>
      <span class="k">super</span><span class="p">.</span><span class="nf">in_time_zone</span><span class="p">(</span><span class="n">time_zone</span><span class="p">)</span> <span class="k">if</span> <span class="n">time_zone</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">end_time</span>
      <span class="k">super</span><span class="p">.</span><span class="nf">in_time_zone</span><span class="p">(</span><span class="n">time_zone</span><span class="p">)</span> <span class="k">if</span> <span class="n">time_zone</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">sort_by_start_time</span>
      <span class="nb">self</span><span class="p">.</span><span class="nf">order</span><span class="p">(</span><span class="s1">'start_time'</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">readable_start_time</span>
      <span class="nb">self</span><span class="p">.</span><span class="nf">start_time</span><span class="p">.</span><span class="nf">strftime</span><span class="p">(</span><span class="s2">"%A, %d %b %Y %l:%M %p"</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">readable_end_time</span>
      <span class="nb">self</span><span class="p">.</span><span class="nf">end_time</span><span class="p">.</span><span class="nf">strftime</span><span class="p">(</span><span class="s2">"%A, %d %b %Y %l:%M %p"</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">tags_attributes</span><span class="o">=</span><span class="p">(</span><span class="n">tag_attributes</span><span class="p">)</span>
      <span class="n">tag_attributes</span><span class="p">.</span><span class="nf">values</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">tag_attribute</span><span class="o">|</span>
        <span class="n">tag</span> <span class="o">=</span> <span class="no">Tag</span><span class="p">.</span><span class="nf">find_or_create_by</span><span class="p">(</span><span class="n">tag_attribute</span><span class="p">)</span> <span class="k">if</span> <span class="n">tag_attribute</span><span class="p">[</span><span class="ss">:name</span><span class="p">].</span><span class="nf">present?</span>
        <span class="nb">self</span><span class="p">.</span><span class="nf">tags</span> <span class="o">&lt;&lt;</span> <span class="n">tag</span> <span class="k">if</span> <span class="n">tag</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">event_cannot_start_in_the_past</span>
      <span class="k">if</span> <span class="nb">self</span><span class="p">.</span><span class="nf">start_time</span><span class="p">.</span><span class="nf">present?</span> <span class="o">&amp;&amp;</span> <span class="nb">self</span><span class="p">.</span><span class="nf">start_time</span> <span class="o">&lt;</span> <span class="no">DateTime</span><span class="p">.</span><span class="nf">now</span>
        <span class="n">errors</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="ss">:start_time</span><span class="p">,</span> <span class="s2">"Event cannot start in the past"</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">event_cannot_end_before_start_time</span>
      <span class="k">if</span> <span class="nb">self</span><span class="p">.</span><span class="nf">end_time</span><span class="p">.</span><span class="nf">present?</span> <span class="o">&amp;&amp;</span> <span class="nb">self</span><span class="p">.</span><span class="nf">start_time</span><span class="p">.</span><span class="nf">present?</span> <span class="o">&amp;&amp;</span> <span class="nb">self</span><span class="p">.</span><span class="nf">end_time</span> <span class="o">&lt;</span> <span class="nb">self</span><span class="p">.</span><span class="nf">start_time</span>
        <span class="n">errors</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="ss">:start_time</span><span class="p">,</span> <span class="s2">"Event cannot end before it starts."</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span></code></pre></figure>

<h1 id="controllers">Controllers:</h1>
<p>We want anyone who comes to the site to be able to view our site, but only users who are signed in to be able to create and go to events. We can <code class="highlighter-rouge">authorize</code> actions by defining policies. We can use Pundit to craft these policies in a <code class="highlighter-rouge">app/policies/resource_policy.rb</code> file. Here’s one for our <code class="highlighter-rouge">Event</code>.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby">  <span class="k">class</span> <span class="nc">EventPolicy</span> <span class="o">&lt;</span> <span class="no">ApplicationPolicy</span>

    <span class="k">def</span> <span class="nf">create?</span>
      <span class="n">user</span><span class="p">.</span><span class="nf">admin?</span> <span class="o">||</span> <span class="n">user</span><span class="p">.</span><span class="nf">moderator?</span> <span class="o">||</span> <span class="n">user</span><span class="p">.</span><span class="nf">normal?</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">update?</span>
      <span class="n">user</span><span class="p">.</span><span class="nf">admin?</span> <span class="o">||</span> <span class="n">user</span><span class="p">.</span><span class="nf">moderator?</span> <span class="o">||</span> <span class="n">record</span><span class="p">.</span><span class="nf">try</span><span class="p">(</span><span class="ss">:organizer</span><span class="p">)</span> <span class="o">==</span> <span class="n">user</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">destroy?</span>
      <span class="n">user</span><span class="p">.</span><span class="nf">admin?</span> <span class="o">||</span> <span class="n">user</span><span class="p">.</span><span class="nf">moderator?</span> <span class="o">||</span> <span class="n">record</span><span class="p">.</span><span class="nf">try</span><span class="p">(</span><span class="ss">:organizer</span><span class="p">)</span> <span class="o">==</span> <span class="n">user</span>
    <span class="k">end</span>

  <span class="k">end</span></code></pre></figure>

<p>Now, only users who created the <code class="highlighter-rouge">record</code>, in this case our event, can make changes or create events, while moderators and admins who are signed in can do the same to any event. Now our controller actions will need a way to call on these policies. We can do that with <code class="highlighter-rouge">authorize</code></p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby">  <span class="k">class</span> <span class="nc">EventsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

    <span class="k">def</span> <span class="nf">create</span>
      <span class="no">Time</span><span class="p">.</span><span class="nf">zone</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="ss">:event</span><span class="p">][</span><span class="ss">:time_zone</span><span class="p">]</span>
      <span class="vi">@event</span> <span class="o">=</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">events</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span><span class="n">event_params</span><span class="p">)</span>
      <span class="vi">@event</span><span class="p">.</span><span class="nf">organizer</span> <span class="o">=</span> <span class="n">current_user</span>
      <span class="k">if</span> <span class="n">authorize</span> <span class="vi">@event</span>
        <span class="k">if</span> <span class="vi">@event</span><span class="p">.</span><span class="nf">save</span>
          <span class="n">redirect_to</span> <span class="n">event_path</span><span class="p">(</span><span class="vi">@event</span><span class="p">)</span>
        <span class="k">else</span>
          <span class="n">render</span> <span class="ss">:new</span><span class="p">,</span> <span class="ss">flash: </span><span class="p">{</span><span class="ss">error: </span><span class="s1">'Uh oh'</span><span class="p">}</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">edit</span>
      <span class="vi">@event</span> <span class="o">=</span> <span class="no">Event</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
      <span class="vi">@users</span> <span class="o">=</span> <span class="vi">@event</span><span class="p">.</span><span class="nf">users</span>
      <span class="vi">@user</span> <span class="o">=</span> <span class="n">current_user</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">update</span>
      <span class="vi">@event</span> <span class="o">=</span> <span class="no">Event</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
      <span class="no">Time</span><span class="p">.</span><span class="nf">zone</span> <span class="o">=</span> <span class="vi">@event</span><span class="p">.</span><span class="nf">time_zone</span>
      <span class="k">if</span> <span class="n">authorize</span> <span class="vi">@event</span>
        <span class="k">if</span> <span class="vi">@event</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">event_params</span><span class="p">)</span>
          <span class="n">redirect_to</span> <span class="n">event_path</span><span class="p">(</span><span class="vi">@event</span><span class="p">)</span>
        <span class="k">else</span>
          <span class="n">render</span> <span class="ss">:edit</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">destroy</span>
      <span class="vi">@event</span> <span class="o">=</span> <span class="no">Event</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
      <span class="n">authorize</span> <span class="vi">@event</span>
      <span class="k">if</span> <span class="vi">@event</span><span class="p">.</span><span class="nf">delete</span>
        <span class="n">redirect_to</span> <span class="n">events_path</span><span class="p">,</span> <span class="ss">flash: </span><span class="p">{</span><span class="ss">message: </span><span class="s1">'Event was succussfelly removed.'</span><span class="p">}</span>
      <span class="k">else</span>
        <span class="n">render</span> <span class="ss">:show</span>
      <span class="k">end</span>
    <span class="k">end</span>

  <span class="k">end</span></code></pre></figure>

<h1 id="views">Views:</h1>
<p>To finish up this post, I’ll include the code for the event views, which utilizes ‘&lt;%= render @event %&gt;’</p>

<figure class="highlight"><pre><code class="language-erb" data-lang="erb"><span class="cp">&lt;%=</span> <span class="n">render</span> <span class="vi">@event</span> <span class="cp">%&gt;</span>

<span class="nt">&lt;h4&gt;</span><span class="cp">&lt;%=</span> <span class="s1">'Attender'</span><span class="p">.</span><span class="nf">pluralize</span><span class="p">(</span><span class="vi">@users</span><span class="p">.</span><span class="nf">count</span><span class="p">)</span> <span class="cp">%&gt;</span> of this Event:<span class="nt">&lt;/h4&gt;</span>

<span class="nt">&lt;p&gt;</span>
  <span class="cp">&lt;%</span> <span class="vi">@users</span><span class="p">.</span><span class="nf">map</span> <span class="k">do</span> <span class="o">|</span><span class="n">attender</span><span class="o">|</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="p">(</span><span class="n">attender</span><span class="p">.</span><span class="nf">name</span> <span class="o">||</span> <span class="n">attender</span><span class="p">.</span><span class="nf">email</span><span class="p">),</span> <span class="n">user_path</span><span class="p">(</span><span class="n">attender</span><span class="p">),</span> <span class="ss">class: </span><span class="s2">"button"</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/p&gt;</span>

<span class="nt">&lt;p&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">user_signed_in?</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">form_tag</span> <span class="n">schedules_path</span><span class="p">,</span> <span class="ss">method: </span><span class="s1">'POST'</span> <span class="k">do</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">hidden_field_tag</span> <span class="ss">:user_id</span><span class="p">,</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">id</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">hidden_field_tag</span> <span class="ss">:event_id</span><span class="p">,</span> <span class="vi">@event</span><span class="p">.</span><span class="nf">id</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">submit_tag</span> <span class="s2">"Go to this event"</span><span class="p">,</span> <span class="ss">class: </span><span class="s1">'button confirm'</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span>  <span class="n">button_to</span> <span class="s2">"Not going anymore"</span><span class="p">,</span> <span class="p">{</span><span class="ss">:controller</span> <span class="o">=&gt;</span> <span class="ss">:schedules</span><span class="p">,</span> <span class="ss">:action</span> <span class="o">=&gt;</span> <span class="s1">'destroy'</span><span class="p">,</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="vi">@event</span><span class="p">.</span><span class="nf">id</span><span class="p">},</span> <span class="ss">:method</span> <span class="o">=&gt;</span> <span class="ss">:delete</span><span class="p">,</span> <span class="ss">class: </span><span class="s1">'button cancel'</span> <span class="k">unless</span> <span class="vi">@users</span><span class="p">.</span><span class="nf">nil?</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/p&gt;</span>
<span class="nt">&lt;/div&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'comments/comments'</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'tags/tags'</span> <span class="cp">%&gt;</span></code></pre></figure>

<p>When <code class="highlighter-rouge">&lt;%= render @events %&gt;</code> is called, Rails will automagically look in the <code class="highlighter-rouge">app/views/events</code> folder for any <code class="highlighter-rouge">_event.hmtl.erb</code> file. It will pass each element in the <code class="highlighter-rouge">@events</code> array and perform the code in the block in the file, whether it’s a single event in a <code class="highlighter-rouge">#show</code> action or many events in <code class="highlighter-rouge">#index</code> action.
<code class="highlighter-rouge">app/views/events/_event.html.erb</code></p>

<figure class="highlight"><pre><code class="language-erb" data-lang="erb"><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"right-info"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;h4&gt;</span>
    <span class="nt">&lt;strong&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">event</span><span class="p">.</span><span class="nf">name</span><span class="p">,</span> <span class="n">event_path</span><span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="cp">%&gt;</span> by <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">event</span><span class="p">.</span><span class="nf">organizer</span><span class="p">.</span><span class="nf">name</span><span class="p">,</span> <span class="n">user_path</span><span class="p">(</span><span class="n">event</span><span class="p">.</span><span class="nf">organizer</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="nt">&lt;/strong&gt;</span>
  <span class="nt">&lt;/h4&gt;</span>
  <span class="nt">&lt;p&gt;</span>
    <span class="nt">&lt;strong&gt;</span>Location:<span class="nt">&lt;/strong&gt;</span> <span class="cp">&lt;%=</span> <span class="n">event</span><span class="p">.</span><span class="nf">location</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;p&gt;</span>
    <span class="nt">&lt;strong&gt;</span>Begins:<span class="nt">&lt;/strong&gt;</span> <span class="cp">&lt;%=</span> <span class="n">event</span><span class="p">.</span><span class="nf">readable_start_time</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;p&gt;</span>
    <span class="nt">&lt;strong&gt;</span>Ends:<span class="nt">&lt;/strong&gt;</span> <span class="cp">&lt;%=</span> <span class="n">event</span><span class="p">.</span><span class="nf">readable_end_time</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;p&gt;</span>
    <span class="nt">&lt;strong&gt;</span>Description:<span class="nt">&lt;/strong&gt;</span> <span class="cp">&lt;%=</span> <span class="n">event</span><span class="p">.</span><span class="nf">description</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;p&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s1">'Edit this event'</span><span class="p">,</span> <span class="n">edit_event_path</span><span class="p">(</span><span class="n">event</span><span class="p">),</span> <span class="ss">class: </span><span class="s1">'button'</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/p&gt;</span>
<span class="nt">&lt;/div&gt;</span></code></pre></figure>

<h2 id="conclusion">Conclusion:</h2>
<p>This has been a quick guide to creating a Rails app with authentication and authorization. This post is by no means extensive or complete, but you can find my full repo on <a href="https://github.com/davdkm/wat-do">github</a>.</p>

  </div>

</article>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">Rubynilia</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>Rubynilia</li>
          <li><a href="mailto:davd.km@gmail.com">davd.km@gmail.com</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/davdkm"><span class="icon icon--github"><svg viewBox="0 0 16 16"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">davdkm</span></a>

          </li>
          

          
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>A blog journaling the bitter sweet road of my Ruby growth.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
